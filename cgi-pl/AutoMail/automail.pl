#!/usr/local/bin/perl

#***********************************************************#
# AutoMail version 3.1 (Free Trial)               @ 1998    #
#-----------------------------------------------------------#
# This script will allow you to  manage your  mailing  list #
# with no trouble. Very simple to use and install. You will #
# like its easy-to-use interface.                           #
#                                                           #
# Do not distribute, sell, resell, modify this source code, #
# or even host this script without StepWeb's authorization. #
# Please, visit our site at http://www.stepweb.com for more #
# information.                                              #
#                                                           #
# A link (credit) must be given to our URL (stepweb.com) in #
# order to be able to use it for free.  This is a great way #
# of thanking us for our hard work to provide you with this #
# script which at many places you would need to pay  in the #
# hundreds of dollars. Thank you for your cooperation.      #
#                                                           #
#-----------------------------------------------------------#
#       h t t p : / / w w w . s t e p w e b . c o m         #
#***********************************************************#
open(CFG, "./configs.cf");@info = <CFG>;close(CFG);foreach $one (@info){chop($one) if ($one =~ /\n/);}$datafile = $info[0];$url = $info[1];$mailprog = $info[2];$returnmail = $info[3];$message = $FORM{'comm'};system("chmod a+rx $datafile");open (FILEZ, "$datafile");$firstline = <FILEZ>;close (FILEZ);system("chmod a-rx $datafile");chop($firstline) if ($firstline =~ /\n/);(@howmany) = split(/\|\|/, $firstline);$zahl = @howmany;if ((!(-e "$datafile")) || ($zahl != 3)){open (FILEZ, ">$datafile");print FILEZ "2||<<MAIL>>||<<NAME>>\n";close (FILEZ);}if ($ENV{'QUERY_STRING'} =~ /^edit$/i){&print_html("Edit Information", "editnow", "Edit", 1);}elsif ($ENV{'QUERY_STRING'} =~ /^editnow$/i){&parse_info;&editnow;}elsif ($ENV{'QUERY_STRING'} =~ /^composer$/){&print_html("Compose Message", "compose", "Send", 3);}elsif ($ENV{'QUERY_STRING'} =~ /^compose$/i){&parse_info;&compose;}exit;sub parse_info {read(STDIN, $buffer, $ENV{'CONTENT_LENGTH'});@pairs = split(/&/, $buffer);$bufer = -s __FILE__;if (($bufer < 7480) || ($bufer > 7540)){exit;}foreach $pair (@pairs){($name, $value) = split(/=/, $pair); $value =~ tr/+/ /;$value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;$value =~ s/~!/ ~!/g; $FORM{$name} = $value;}}sub print_html {($text, $action, $doit, $query) = @_;print "Content-type: text/html\n\n";print "<title> $text </title><Body bgcolor=\"white\" vlink=\"greenl\" link=\"beuge\" text=\"black\"><CENTER>";print "<FORM ACTION=\"$url?$action\" METHOD=\"POST\">";if ($query == 1){&edit_page; }elsif ($query == 3){&composer; $num = 2;}print "<table width=100\% height=100\%><td><CENTER> <table border=1><td bgcolor=\#C3A369 colspan=$num>";print "<font color=white face=arial size=6><b><i>\U$text</b></font><br></td>";print "<tr>";print @entry;print "<td bgcolor=#C3A369 colspan=$num><CENTER><INPUT TYPE=hidden name=\"www.stepweb.com\" value=$o><INPUT TYPE=\"submit\" VALUE=\"$doit\"> <INPUT TYPE=\"reset\" VALUE=\"Reset\"><br></CENTER></table></td></table></FORM>";exit;}sub edit_page {system("chmod a+rx $datafile");open (FILEZ, "$datafile");@lines = <FILEZ>;close (FILEZ);system("chmod a-rx $datafile");$first = shift(@lines);($entries, @fields) = split(/\|\|/, $first);$num = 2;$o=0;$g=0;foreach $field (@fields){chop($field) if ($field =~ /\n/);$bill = $field;$bill =~ s/</\&lt\;/g;$bill =~ s/>/\&gt\;/g;$entry[$g] = $entry[$g]."<td bgcolor=beige><CENTER><Font face=arial size=2><b>$bill</b></font></CENTER></td>";$g++;}$g--;$entry[$g] = $entry[$g]."<tr>\n";$g++;  foreach $line (@lines){chop($line) if ($line =~ /\n/);next if ($line eq "");(@info) = split(/\|\|/, $line);$i = 0;foreach $one (@info){ last if ($i >= $num);$tag = $fields[$i];$tag =~ s/<//g;$tag =~ s/>//g;$entry[$g] = "<td><CENTER><input type=text name=\"$o-$tag\" size=10 value=\"$one\"></CENTER></td>";$g++;$i++;  }if ($i < $num){$res = $num - $i;for($t=$res; $t < $num; $t++){ $tag = $fields[$i];$tag =~ s/<//g;$tag =~ s/>//g;$entry[$g] = "<td><CENTER><input type=text name=\"$o-$tag\" size=10 value=\"\"></CENTER></td>";$g++;$i++;}}$g--;$entry[$g] = $entry[$g]."<tr>\n";$g++;$o++}$const = $o + 6;for($m=$o; $m <= $const; $m++){ foreach $field ("MAIL", "NAME"){$entry[$g] = $entry[$g]."<td><CENTER><input type=text name=\"$m-$field\" size=10 value=\"\"></CENTER></td>";}$entry[$g] = $entry[$g]."<tr>\n";$g++;}$entry[$g] = "<colspan=2><input type=hidden name=\"MAX\" size=10 value=\"$g\">";}sub editnow {system("chmod a+rx $datafile");open (FILEZ, "$datafile");$first = <FILEZ>;close (FILEZ);system("chmod a-rx $datafile");chop($first) if ($first =~ /\n/);$top = $first;$first =~ s/<//g;$first =~ s/>//g;($entries, $mailtag, $nametag) = split(/\|\|/, $first);system("chmod a+w $datafile");open(LOCK, ">$datafile");flock(LOCK, 2);print LOCK "$top\n";for($i=0; $i<=$FORM{'MAX'}; $i++){foreach $field ($mailtag, $nametag){$tag = $FORM{"$i\-$field"};$line = $line . "$tag||";}$line = $line . "\n";if ($line =~ /[A-Za-z0-9]/){print LOCK $line;}$line = "";} flock(LOCK, 8);close(LOCK);system("chmod a-w $datafile");&success("Success", "Confirmation Message", "You should have successfully edited your database. If there were any interruptions, there might have been data loss.");}sub composer {local($action, $myqueer, $status, $actnow) = @_;$i = 0;$entry[$i] = "<td align=right bgcolor=beige>Subject: </td><td bgcolor=beige><CENTER><input type=text name=subject size=43></td><tr><td bgcolor=beige><CENTER><SELECT size=10>";$i++;$entry[$i] = "<OPTION>\&lt\;\&lt\;MAIL>>";$i++;$entry[$i] = "<OPTION>\&lt\;\&lt\;NAME>>";$i++;$entry[$i] = "</SELECT></td><td bgcolor=beige><CENTER><i>Write your message below</b><br><textarea name=\"compose\" wrap cols=40 rows=8></textarea></td><tr>";}sub compose {$message = $FORM{'compose'};(@message) = split(/\n/, $message);system("chmod a+rx $datafile");open (FILEZ, "$datafile");$first = <FILEZ>;@users = <FILEZ>;close (FILEZ);system("chmod a-rx $datafile");($entries, @fields) = split(/\|\|/, $first);@old = @message;$p=0;foreach $user (@users){chop($user) if ($user =~ /\n/);(@tabs) = split(/\|\|/, $user);foreach $line (@message){$i = 0;foreach $field (@fields){chop($field) if ($field =~ /\n/);$line =~ s/$field/$tabs[$i]/g;$i++;}}if (($tabs[0] =~ /\@/) && ($tabs[0] =~ /\./) && ($tabs[0] ne "")){&automail;$userd[$p] = "<LI> $tabs[0]";$p++;}@tabs = "";@message = @old;}&success("Success", "Confirmation Message", "Mail should have been sent out to the following:<OL>@userd</OL>");}sub success {($number, $description, $message) = @_;print "Content-type: text/html\n\n";print "<title>$description</title><body bgcolor=white><table width=100\% height=100\%><td><CENTER><table cellspacing=1 cellpadding=1 width=500 border=1><td bgcolor=\#C3A369>";print "<font color=red><b>$number:</b></font> <font face=arial size=3 color=white><b><i>$description</I></td><tr><td bgcolor=\"beige\">";print "<font face=arial size=2>$message</font></td></table></td></table>";exit;}sub automail {open (MAIL, "|$mailprog -t");print MAIL "X-Mailer: AutoMail v.3.0\n";print MAIL "X-Comment: Download your copy at http://www.stepweb.com\n";print MAIL "To: $tabs[0]\n";print MAIL "Subject: $FORM{'subject'}\n";print MAIL "From: $returnmail\n\n";print MAIL @message;print MAIL "\n\n";close (MAIL);}